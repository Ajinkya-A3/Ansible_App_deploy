---
- name: Install dependencies (Python, pip, venv, Git, Nginx)
  package:
    name:
      - nginx
      - python3
      - python3-pip
      - python3-venv
      - git
    state: present

- name: Clone To-Do app repository
  git:
    repo: "https://github.com/Ajinkya-A3/to-do-app.git"
    dest: /var/www/todo
    version: main

- name: Create virtual environment
  command: python3 -m venv /var/www/todo/venv
  args:
    creates: /var/www/todo/venv

- name: Install Python dependencies in venv
  pip:
    requirements: /var/www/todo/requirements.txt
    virtualenv: /var/www/todo/venv

- name: Configure Nginx
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/todo
  notify: Restart nginx

- name: Enable Nginx site
  file:
    src: /etc/nginx/sites-available/todo
    dest: /etc/nginx/sites-enabled/todo
    state: link
    force: yes

- name: Remove default site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Start and enable Nginx
  service:
    name: nginx
    state: started
    enabled: yes

- name: Create systemd service for Flask app
  copy:
    dest: /etc/systemd/system/todo.service
    content: |
      [Unit]
      Description=To-Do Flask App
      After=network.target

      [Service]
      User=www-data
      WorkingDirectory=/var/www/todo
      ExecStart=/var/www/todo/venv/bin/python /var/www/todo/app.py
      Restart=always

      [Install]
      WantedBy=multi-user.target

- name: Enable and start To-Do service
  systemd:
    name: todo
    state: started
    enabled: yes

# Handler
- name: Restart nginx
  service:
    name: nginx
    state: restarted
